version: 2.1
orbs:
  node: circleci/node@4.7.0
  android: circleci/android@1.0.3
  rn: react-native-community/react-native@7.0.0

commands:
  last-commit:
    steps:
      - run:
          name: 'Get last commit'
          command: echo "export LAST_COMMIT=$(git rev-parse --verify HEAD)" >> $BASH_ENV

  detox_build_android:
    steps:
      - android/restore-gradle-cache
      - run: |
          npm install -g detox-cli react-native-cli
          detox build --configuration android
          cd android/app/build/outputs/apk && ls
      - android/save-gradle-cache

  start_react_native:
    steps:
      - run:
          background: true
          command: >
              yarn start

  adb_reserve:
    steps:
      - run: |
          lsof -i -P -n | grep 8081
          adb devices -l
          adb reverse tcp:8081 tcp:8081

  detox_build_ios:
    steps:
      - restore_cache:
          keys: 
            - ios-build-cache-{{ arch }}-{{ checksum "~/.tmp/checksumfiles/package.json" }}
      - run: |
          npm install -g detox-cli react-native-cli
          xcodebuild -workspace ios/yojeeDriverApp.xcworkspace -scheme YojeeDev -sdk iphonesimulator -derivedDataPath ios/build
      - save_cache:
          key: ios-build-cache-{{ arch }}-{{ checksum "~/.tmp/checksumfiles/package.json" }}
          paths:
            - ios/build/Build


jobs:
  setup_node:
    working_directory: ~/driver-react-native
    docker:
      - image: cimg/node:12.16

    steps:
      - last-commit

      - checkout:
          path: ~/driver-react-native

      - attach_workspace:
          at: ~/driver-react-native

      - restore_cache:
          key: yarn-{{ .Environment.CACHE_VERSION }}-{{ checksum "yarn.lock" }}-{{ arch }}

      - restore_cache:
          key: node-{{ .Environment.CACHE_VERSION }}-{{ checksum "package.json" }}-{{ arch }}

      - run: yarn install

      - persist_to_workspace:
          root: ~/driver-react-native
          paths:
            - .

  detox_android:
    executor:
      name: android/android-machine
      resource-class: large
    steps:
      - checkout
      - node/install-yarn
      - rn/yarn_install
      - rn/android_emulator_start:
          device_name: Pixel_5_API_32
          platform_version: android-32
          build_tools_version: 30.0.0
      # - detox_build_android
      # - start_react_native
      # - run:  |
      #       detox test -c android --loglevel trace --record-videos all
      # - run: node e2e/generate_cucumber_html_report
      # - store_artifacts:
      #     path: e2e/cucumber-report

  detox_ios:
    executor:
      name: rn/macos
      xcode_version: 12.5.1
    steps:
      - checkout
      - rn/setup_macos_executor
      - rn/yarn_install:
          cache_folder: ~/.cache/yarn
      - rn/pod_install
      - rn/ios_simulator_start:
          device: iPhone 12
      - start_react_native
      - detox_build_ios
      - run: DETOX_CONFIGURATION=ios.sim.release npx cucumber-js
      - store_artifacts:
          path: e2e/cucumber-json

workflows:
  e2e:
    jobs:
      - detox_android
      # - detox_ios:
      #     filters:
      #       branches:
      #         only:
      #           - /detox_automation\/qa.*/
